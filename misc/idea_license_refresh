#!/bin/bash
##
## Before running you should:
##
## 1. Check IDEA version -- the IDEA folder (see code below)
##    must exist and belong to the currently used idea installation.
##    You can override this as follows: ./idea_license_refresh -ideafolder "~/.IntelliJIdea2018.4"
##
## Reminder to backup your settings!
##
## 1. File -> Export settings
## 2. close IDE
## 3. Save settings.jar in a safe place!

set -e

HOM=$HOME

while getopts "h:d:" OPTION; do
    case $OPTION in
    h)
        HOM=$OPTARG
        ;;
    d)
        IDEA=$OPTARG
        ;;
    *)
        echo "Incorrect options provided"
        exit 1
        ;;
    esac
done

if [[ -z "$IDEA" ]]; then
  IDEA="$(find $HOM -mindepth 1 -maxdepth 1 -type d | grep -F IntelliJIdea | sort | tail -n 1)"
  if [[ -z "$IDEA" ]]; then
    echo "Folder IDEA folder not found in $HOM."
    echo "You can specify this folder with the -d ( and -h ) options."
    exit 1
  fi
else
  if [[ ! -d "${HOM}/${IDEA}" ]]; then
    echo "IDEA folder not found in ${HOM}"
    echo "You can specify this folder with the -d ( and -h ) options."
    exit 1
  fi
fi

echo "Using IDEA base folder -h = $HOM"
echo "Using IDEA folder $HOM/$IDEA"
echo "---"
for F in `ls -t -a -1 $HOM | grep -F IntelliJIdea`; do
    if [[ "$F" == "$IDEA" ]]; then
        echo "* $HOM/$F"
    else
        echo "  $HOM/$F"
    fi
done
echo "---"
echo "If you prefer, you can quit this program now and start over,"
echo "specifying another folder with the -h and -d options."
echo "Continue? [n|Y]"
ask

BACKUP="$HOME/backup/$(date --iso-8601)"

function ask() {
  read CONFIRMATION
  if [[ -n "$CONFIRMATION" ]] && [[ "$CONFIRMATION" != "y" ]] && [[ "$CONFIRMATION" != "Y" ]]; then
    echo "quitting now"
    exit 0
  fi
}

if [[ -d "$BACKUP" ]]; then
  echo "Error: Backup folder exists: $BACKUP"
  exit 1
fi

echo "Using IDEA folder: $IDEA"
echo
echo "Please make sure to backup your IDEA settings!"
echo "(File -> Export settings)"
echo "Please be sure to store a copy of settings.zip outside of $HOM/$IDEA."
echo
echo "Your settings will be lost if you don't have a backup."
echo "Please be sure that IDEA is not running before you proceed."
echo "Continue? [n|Y]"
ask

echo "Creating backup in $BACKUP"
mkdir -p $BACKUP

set -x

## Remove prefs.xml
if [[ -f "$HOME/.java/.userPrefs/prefs.xml" ]]; then
  mv "$HOME/.java/.userPrefs/prefs.xml" $BACKUP
  ## ..but keep lines that don't contain the word JetBrains
  grep -F -v JetBrains $BACKUP/prefs.xml >$HOME/.java/.userPrefs/prefs.xml
fi

## Remove jetbrains preferences folder
if [[ -d "$HOME/.java/.userPrefs/jetbrains" ]]; then
  mv "$HOME/.java/.userPrefs/jetbrains" $BACKUP
fi

## Remove idea folder
mv $IDEA $BACKUP
set +x

echo "Refresh is done."
echo "It is recommended to download a fresh idea release now."
