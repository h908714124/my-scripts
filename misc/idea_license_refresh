#!/bin/bash
##
## Before running you should:
##
## 1. Check IDEA version -- the folder (see code below)
##    must exist and be the one you're currently using.
##    It could exist but be leftover from a previous installation.
##    In that case, change the script to use the correct IDEA folder.
##
## Also don't forget to backup your settings!
##
## 1. File -> Export settings
## 2. close IDE
## 3. Save settings.jar in a safe place!

set -e

BACKUP=~/backup/$(date --iso-8601)

IDEA=~/.IntelliJIdea2018.3

if [[ ! -d $IDEA ]]; then
  echo "Error: Expected IDEA folder not found: $IDEA"
  echo "Are you using a different IDEA version?"
  exit 1
fi

if [[ -d $BACKUP ]]; then
  echo "Error: Backup folder exists: $BACKUP"
  exit 1
fi

echo "Please make sure to backup your IDEA settings!"
echo "Continue? [n|Y]"
read CONFIRMATION
if [[ ! -z "$CONFIRMATION" ]] && [[ "$CONFIRMATION" != "y" ]] && [[ "$CONFIRMATION" != "Y" ]]; then
	echo "quitting now"
	exit 0
fi

echo "Creating backup in $BACKUP"
mkdir -p $BACKUP

set -x
## Remove prefs.xml
mv ~/.java/.userPrefs/prefs.xml $BACKUP

## ..but keep lines that don't contain the word JetBrains
grep -F -v JetBrains $BACKUP/prefs.xml >~/.java/.userPrefs/prefs.xml

## Remove jetbrains preferences folder
mv ~/.java/.userPrefs/jetbrains/ $BACKUP

## Remove idea folder
mv $IDEA $BACKUP

## Now open idea and re-import settings.jar
## Done!
