#!/bin/bash
##
## Before running you should:
##
## 1. Check IDEA version -- the IDEA folder (see code below)
##    must exist and belong to the currently used idea installation.
##    You can override this as follows: ./idea_license_refresh -ideafolder "~/.IntelliJIdea2018.4"
##
## Reminder to backup your settings!
##
## 1. File -> Export settings
## 2. close IDE
## 3. Save settings.jar in a safe place!

set -e

BACKUP=~/backup/$(date --iso-8601)

IDEA=~/.IntelliJIdea2018.3

if [[ "$1" == "-ideafolder" ]]; then
  if [[ -n "$2" ]]; then
    echo "Value expected"
    exit 1
  fi
  IDEA="$2"
fi

if [[ ! -d "$IDEA" ]]; then
  echo "IDEA folder not found: $IDEA"
  echo "You can specify this folder with the -ideafolder option."
  exit 1
fi

echo "Found IDEA folder: $IDEA"
echo "Is this from the idea version that's currently used?"
echo "Otherwise, start this script with the -ideafolder option."
echo "[Y|n]"
read CONFIRMATION
if [[ ! -z "$CONFIRMATION" ]] && [[ "$CONFIRMATION" != "y" ]] && [[ "$CONFIRMATION" != "Y" ]]; then
  echo "quitting now"
  exit 0
fi

if [[ -d "$BACKUP" ]]; then
  echo "Error: Backup folder exists: $BACKUP"
  exit 1
fi

echo "Please make sure to backup your IDEA settings!"
echo "(File -> Export settings)"
echo "Your settings will be lost if you don't have a backup!"
echo "Continue? [Y|n]"
read CONFIRMATION
if [[ ! -z "$CONFIRMATION" ]] && [[ "$CONFIRMATION" != "y" ]] && [[ "$CONFIRMATION" != "Y" ]]; then
	echo "quitting now"
	exit 0
fi

echo "Creating backup in $BACKUP"
mkdir -p $BACKUP

set -x
## Remove prefs.xml
mv ~/.java/.userPrefs/prefs.xml $BACKUP

## ..but keep lines that don't contain the word JetBrains
grep -F -v JetBrains $BACKUP/prefs.xml >~/.java/.userPrefs/prefs.xml

## Remove jetbrains preferences folder
mv ~/.java/.userPrefs/jetbrains/ $BACKUP

## Remove idea folder
mv $IDEA $BACKUP
set +x

echo "Refresh is done."
echo "It is recommended to also download a fresh idea release now."
