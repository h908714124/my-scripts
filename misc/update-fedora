#!/bin/bash

assume_yes=false

read_yes() {
  echo "$@"
  echo "y"
  REPLY=y
}

release_type() {
  sed -n -E 's/^RELEASE_TYPE=(\S+)/\1/p' /etc/os-release
}

os_release() {
  sed -n -E 's/^VERSION_ID=(\S+)/\1/p' /etc/os-release
}

target_release() {
  local current=$(os_release)
  if [[ $(release_type) != "stable" ]]; then
    echo $current
    return 0
  fi
  local arch=$(uname -m)
  local result=$(curl -s "https://fedoraproject.org/releases.json" |\
    jq -r ".[]|select( .arch == \"$arch\") |.version" |\
    sort -rn | head -1)
  if (( result >= current )); then
    echo $result
  else
    echo $current
  fi
}

update_show() {
  sudo dnf check-update --refresh
}

is_update_prepared() {
  sudo dnf offline status | grep -F -q "offline reboot"
}

check_updates_available() {
  [[ $(update_show 2> /dev/null) ]]
}

system_update() {
  local target=$1
  sudo dnf -y system-upgrade download --releasever=$target && {
    $read_p "A system update is prepared. Would you like to reboot right now? [y/N] "
    [[ $REPLY =~ [yY] ]] && sudo dnf -y offline reboot
  }
}

update_apply() {
  sudo dnf -y update --refresh
}

update_download() {
  sudo dnf -y update --refresh --offline && {
    $read_p "An update is prepared. Would you like to reboot right now? [y/N] "
    [[ $REPLY =~ [yY] ]] && sudo dnf -y offline reboot
  }
}

default_action() {
  read_p="read -p"
  [[ $1 = "-y" ]] && {
    read_p=read_yes
    assume_yes=true
  }
  is_update_prepared && {
    $read_p "An update is prepared. Would you like to reboot right now? [y/N] "
    [[ $REPLY =~ [yY] ]] && sudo dnf -y offline reboot
    return 0
  }
  check_updates_available && {
    while true; do
      $read_p "An update is available. Show / download / apply / nothing? [s/d/a/n] "
      [[ $REPLY = "s" ]] && {
        update_show
      }
      [[ $REPLY = "d" ]] && {
        update_download
        return 0
      }
      [[ $REPLY = "a" ]] && {
        update_apply
        return 0
      }
      [[ $REPLY = "n" ]] && return 0
    done
  }
  local current=$(os_release)
  local target=$(target_release)
  if (( current == target )); then
    echo "The system is up-to-date."
    if ! $assume_yes && [[ $(release_type) = "stable" ]]; then
      read -p "Would you like to upgrade to rawhide? [y/N] "
      [[ $REPLY =~ [yY] ]] && system_update rawhide
    fi
  else
    $read_p "A system update to fedora $(( current + 1 )) is available. Would you like to download it now? [y/N] "
    [[ $REPLY =~ [yY] ]] && system_update $(( current + 1 ))
  fi
  return 0
}

return 2> /dev/null || {
  default_action $@
}
