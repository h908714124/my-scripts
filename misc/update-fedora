#!/bin/bash

target_release() {
  curl -s "https://fedoraproject.org/releases.json" | jq -r '[.[].version]|max'
}

is_update_prepared() {
  dnf offline status | grep -F -q "offline reboot"
}

check_updates_available() {
  dnf check-update
  local n=$(dnf updateinfo summary 2>&1 | sed -n -E 's/.*([0-9]+)$/\1/p' | paste -sd+ | bc)
  (( n > 0 ))
}

current_release() {
  sed -n -E 's/^VERSION_ID=(\S+)/\1/p' /etc/os-release
}

system_update() {
  local target=$1
  local REPLY
  dnf -y system-upgrade download --releasever=$target && {
    read -p "The system update is prepared. Would you like to reboot right now? [y/N] "
    [[ $REPLY =~ [yY] ]] && dnf -y offline reboot
  }
}

regular_update() {
  local REPLY
  dnf -y update --refresh --offline && {
    read -p "The update is prepared. Would you like to reboot right now? [y/N] "
    [[ $REPLY =~ [yY] ]] && dnf -y offline reboot
  }
}

default_action() {
  local REPLY
  is_update_prepared && {
    read -p "An update is prepared. Would you like to reboot right now? [y/N] "
    [[ $REPLY =~ [yY] ]] && dnf -y offline reboot
    return 0
  }
  check_updates_available && {
    read -p "An update ist available. Would you like to download it now? [y/N] "
    [[ $REPLY =~ [Yy] ]] && regular_update
    return 0
  }
  local current=$(current_release)
  local target=$(target_release)
  if (( current == target )); then
    echo "The system is up-to-date."
  elif (( target - current == 1 )); then
    read -p "A system update to fedora $target is available. Would you like to download it now? [y/N] "
    [[ $REPLY =~ [Yy] ]] && system_update $target
    return 0
  else
    echo "The system is too far behind. Please update manually."
  fi
}

return 2> /dev/null || {
  [[ $EUID = "0" ]] || {
    echo "run as root"
    exit 1
  }
  default_action
}
