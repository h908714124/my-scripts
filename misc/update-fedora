#!/bin/bash

read_yes() {
  echo "$@"
  echo "y"
  REPLY=y
}

os_release() {
  sed -n -E 's/^VERSION_ID=(\S+)/\1/p' /etc/os-release
}

target_release() {
  local arch=$(uname -m)
  local result=$(curl -s "https://fedoraproject.org/releases.json" |\
    jq -r ".[]|select( .arch == \"$arch\") |.version" |\
    sort -rn | head -1)
  local current=$(os_release)
  if (( result >= current )); then
    echo $result
  else
    echo $current
  fi
}

is_update_prepared() {
  dnf offline status | grep -F -q "offline reboot"
}

check_updates_available() {
  [[ $(dnf check-update --refresh 2> /dev/null) ]]
}

system_update() {
  local target=$1
  dnf -y system-upgrade download --releasever=$target && {
    $read_p "The system update is prepared. Would you like to reboot right now? [y/N] "
    [[ $REPLY =~ [yY] ]] && dnf -y offline reboot
  }
}

normal_update() {
  dnf -y update --refresh --offline && {
    $read_p "The update is prepared. Would you like to reboot right now? [y/N] "
    [[ $REPLY =~ [yY] ]] && dnf -y offline reboot
  }
}

default_action() {
  read_p="read -p"
  [[ $1 = "-y" ]] && read_p=read_yes
  is_update_prepared && {
    $read_p "An update is prepared. Would you like to reboot right now? [y/N] "
    [[ $REPLY =~ [yY] ]] && dnf -y offline reboot
    return 0
  }
  check_updates_available && {
    $read_p "An update is available. Would you like to download it now? [y/N] "
    [[ $REPLY =~ [yY] ]] && normal_update
    return 0
  }
  local current=$(os_release)
  local target=$(target_release)
  if (( current == target )); then
    echo "The system is up-to-date."
  else
    $read_p "A system update to fedora $(( current + 1 )) is available. Would you like to download it now? [y/N] "
    [[ $REPLY =~ [yY] ]] && system_update $(( current + 1 ))
  fi
  return 0
}

return 2> /dev/null || {
  if [[ $EUID = "0" ]]; then
    default_action $@
  else
    sudo true || {
      echo -e "\033[1;31m[ERROR]\033[0m insufficient privileges"
      exit 1
    }
    sudo bash -c "$(declare -f); default_action $@"
  fi
}
